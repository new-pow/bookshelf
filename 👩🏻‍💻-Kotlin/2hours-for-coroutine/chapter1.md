# ë“¤ì–´ê°€ê¸° ì „ì—
ì½”ë£¨í‹´ì€ ì½”í‹€ë¦°ì„ ì ‘í•˜ë©´ì„œ ê°€ì¥ í—·ê°ˆë ¸ë˜ ê°œë… ì¤‘ í•˜ë‚˜ì…ë‹ˆë‹¤.
ê·¸ë˜ì„œ í‹ˆí‹ˆì´ ì¸í”„ëŸ° ê°•ì˜ë„ ë³´ê³  ì´ê²ƒì €ê²ƒ ê¸€ë„ ì°¾ì•„ë³´ë©° í•™ìŠµí•˜ê³  ìˆëŠ”ë°ìš”. ì¡°ê¸ˆì”© í•™ìŠµí–ˆë˜ ê²ƒë“¤ì„ ì •ë¦¬í•˜ë©°, ë” ê¹Šì´ ë‚¨ê¸°ê¸° ìœ„í•´ ì´ ê¸€ì„ ì‘ì„±í•´ë³´ì•˜ìŠµë‹ˆë‹¤.
í˜¹ì‹œë‚˜ ë¶€ì¡±í•œ ë¶€ë¶„ì´ ìˆë‹¤ë©´ ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš” ğŸ˜€

- ì•„ë˜ ê°œë…ì„ ì „ì œí•˜ì—¬ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤ë§Œ ì´ ê¸€ì—ì„œ ë‹¤ë£¨ê³  ìˆì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.
	- í”„ë¡œì„¸ìŠ¤, ìŠ¤ë ˆë“œ
	- ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹˜ context switch
	- ë™ì‹œì„±, ë³‘ë ¬ì„±
	- ë©”ëª¨ë¦¬ ìŠ¤íƒì˜ì—­, í™ì˜ì—­
	- ë™ê¸° í”„ë¡œê·¸ë˜ë°, ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°

# Coroutine
- `co`ëŠ” 'í˜‘ë ¥í•˜ëŠ”'ì´ë¼ëŠ” ì˜ë¯¸ê°€ ìˆëŠ” ì ‘ë‘ì‚¬ì…ë‹ˆë‹¤. `routine`ì€ ì»´í“¨í„° ê³µí•™ì—ì„œ ì´ì•¼ê¸°í•˜ëŠ” ë£¨í‹´ì…ë‹ˆë‹¤. ì¦‰, í˜‘ë ¥í•˜ëŠ” í•¨ìˆ˜ë¼ëŠ” ì˜ë¯¸ì…ë‹ˆë‹¤.
- Coroutineì€ Kotlin ì–¸ì–´ë¥¼ ê°œë°œí•œ Jetbrain ì´ ê°œë°œìë“¤ì´ ê²ªëŠ” ìŠ¤ë ˆë”© ë¬¸ì œë¥¼ ì§ê´€ì ì¸ ë°©ì‹ìœ¼ë¡œ í•´ê²°í•  ìˆ˜ìˆë„ë¡ ì¶”ê°€í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

## Routine ê³¼ Coroutine
- ì¼ë°˜ì ì¸ Routineì€ ë‹¤ìŒê³¼ ê°™ì€ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ì„ ê°€ì§‘ë‹ˆë‹¤.

```
    +--------------+          +-------------+
    | Main Routine |          | sub Routine |
    +--------------+          +-------------+
         |                           |
         |        routine ì‹œì‘        |
         |-------------------------->|
         |                           |
         |                           |
         |                           |
         |                           |
         |                           |
         |                           | 
         |<--------------------------|
         |        routine ì¢…ë£Œ       ì´ˆê¸°í™”
         |
```

ë£¨í‹´ì€ ì´ëŸ° íŠ¹ì§•ì´ ìˆìŠµë‹ˆë‹¤.
- ë£¨í‹´ì€ ì§„ì…í•˜ëŠ” ê³³ì´ í•œ ê³³ì…ë‹ˆë‹¤.
- í•œ ë²ˆ ì‹œì‘í•˜ë©´ ì¢…ë£Œë  ë•Œê¹Œì§€ ë©ˆì¶”ì§€ ì•ŠìŠµë‹ˆë‹¤.
- ë£¨í‹´ì´ ì¢…ë£Œë˜ë©´ ê·¸ ë£¨í‹´ì—ì„œ ì‚¬ìš©í–ˆë˜ ì •ë³´ê°€ ë©”ëª¨ë¦¬ì—ì„œ ì´ˆê¸°í™” ë˜ì–´ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì§€ì—­ë³€ìˆ˜)
---
- ì•„ë˜ëŠ” coroutine ì— ëŒ€í•œ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ì…ë‹ˆë‹¤.

```
    +----------------+          +---------------+
    | Main coRoutine |          | sub coRoutine |
    +----------------+          +---------------+
         |                              |
         |         routine ì‹œì‘          |
         |----------------------------->|
         |             ì¤‘ë‹¨              |
         |<-----------------------------|
         |                              |
         |                              |
         |                              |
         |             ì¬ê°œ              |
         |----------------------------->|
         |<-----------------------------|
         |         routine ì¢…ë£Œ
         |
```

- ì½”ë£¨í‹´ì€ ì¤‘ë‹¨í•˜ê³  ì¬ê°œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
	- ì¤‘ë‹¨-ì¬ê°œì˜ ë‹¨ìœ„ëŠ” ì½”ë“œìƒìœ¼ë¡œ ì •ì˜ëœ ë¸”ë¡ì…ë‹ˆë‹¤.
- ì½”ë£¨í‹´ì´ ì™„ì „íˆ ì¢…ë£Œë˜ê¸° ì „ê¹Œì§€ ì¤‘ë‹¨ëœ ì½”ë£¨í‹´ í•¨ìˆ˜ ì•ˆì— ìˆëŠ” ì •ë³´ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ì œê±°ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

ì—¬ê¸°ì„œ ì½”ë£¨í‹´ì´ ì™„ì „íˆ ì¢…ë£Œë˜ê¸° ì „ê¹Œì§€ ë©”ëª¨ë¦¬ì—ì„œ í•´ë‹¹ ì½”ë£¨í‹´ì— ëŒ€í•œ ì •ë³´ê°€ ê³„ì† ë‚¨ì•„ìˆë‹¤ëŠ” ì ì´ ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. ì´ëŠ” ìŠ¤ë ˆë“œì™€ ì½”ë£¨í‹´ì˜ ê´€ê³„ì™€ ì°¨ì´ì ì„ ë³´ë©´ ëª…í™•íˆ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Thread ì™€ Coroutine
ìœ„ì—ì„œ ì–¸ê¸‰í•˜ì˜€ë“¯ì´ ì½”ë£¨í‹´ì€ ìŠ¤ë ˆë“œë³´ë‹¤ ë” ì‘ì€ ì‘ì—…ë‹¨ìœ„ì´ê¸°ë„ í•©ë‹ˆë‹¤.
![](https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fg9-h6CWPz8p_pmHGktpyg.png)

ì½”ë£¨í‹´ì€ ì½”ë“œ ì¢…ë¥˜ ì¤‘ í•˜ë‚˜ì´ê¸° ë•Œë¬¸ì— ì´ë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ ìŠ¤ë ˆë“œê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤. ë£¨í‹´ì„ ì‹¤í–‰í•˜ë ¤ë©´ ìŠ¤ë ˆë“œê°€ ë°°ì •ë˜ì–´ ìˆì–´ì•¼ í•˜ëŠ” ê²ƒì²˜ëŸ¼ìš”.

ê·¸ë˜ì„œ ì–¼í• ë³´ë©´ í”„ë¡œì„¸ìŠ¤-ìŠ¤ë ˆë“œì™€ ìŠ¤ë ˆë“œ-ì½”ë£¨í‹´ì€ ë¹„ìŠ·í•œ ê´€ê³„ ê²ƒì²˜ëŸ¼ ë³´ì…ë‹ˆë‹¤.
í•˜ì§€ë§Œ ìŠ¤ë ˆë“œì™€ ë‹¬ë¦¬ ì½”ë£¨í‹´ì€ ì¤‘ë‹¨ê³¼ ì¬ê°œë¥¼ í•  ìˆ˜ ìˆê³  **í•˜ë‚˜ì˜ ì½”ë£¨í‹´ì´ ìŠ¤ë ˆë“œ ì—¬ëŸ¬ê°œì— ê±°ì³ ì‹¤í–‰ë  ìˆ˜ ìˆë‹¤ëŠ” ì°¨ì´ì ì´ ìˆìŠµë‹ˆë‹¤.**

ìœ„ì˜ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ì—ì„œ ë£¨í‹´ì€ 2ê°œê°€ ì‹¤í–‰ë˜ê³  ìˆì§€ë§Œ, 3ê°œì˜ ìŠ¤ë ˆë“œì—ì„œ ê°ê° ë‚˜ë‰˜ì–´ ì‹¤í–‰ë  ìˆ˜ ìˆëŠ” ê²ƒì…ë‹ˆë‹¤. (ë¬¼ë¡ , ë” ì ì€ ìŠ¤ë ˆë“œì— ë‚˜ë‰  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.)

```
      A thread
    +----------------+          +---------------+
    | Main coRoutine |          | sub coRoutine |
    +----------------+          +---------------+
         |                              |
         |    routine ì‹œì‘(B thread)     |
         |----------------------------->|
         |             ì¤‘ë‹¨              |
         |<-----------------------------|
         |                              |
         |                              |
         |                              |
         |         ì¬ê°œ(C thread)        |
         |----------------------------->|
         |<-----------------------------|
         |         routine ì¢…ë£Œ
         |
```

- ë‹¤ì‹œ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ì„ ê·¸ë ¤ë³´ìë©´ ì´ëŸ°ì‹ì…ë‹ˆë‹¤.
```
       A thread                    B thread                    C thread
    +----------------+          +-----------------+          +-----------------+
    | Main coroutine |          | Sub coroutine-1 | ë™ì¼ ì½”ë£¨í‹´ | Sub coroutine-2 |
    +----------------+          +-----------------+          +-----------------+
         |                              |                            
         |     routine ì‹œì‘              |                            
         |----------------------------->|                            
         |                              |                            
         |             ì¤‘ë‹¨              |                            
         |<-----------------------------|                            
         |                                                           
         |                                                           
         |                                                           
         |                                       ì¬ê°œ                 
         |---------------------------------------------------------->|
         |                                                           |
         |<----------------------------------------------------------|
         |         routine ì¢…ë£Œ                                       
         |                                                           

```

ìŠ¤ë ˆë“œì˜ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ê³¼ ì½”ë£¨í‹´ì˜ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ì˜ ë¹„ìš©ì—ë„ ì°¨ì´ì ì´ ìˆìŠµë‹ˆë‹¤.

- ìŠ¤ë ˆë“œì˜ ê²½ìš°
	- í”„ë¡œì„¸ìŠ¤ ë‚´ì—ì„œ í™ ì˜ì—­ì„ ê³µìœ í•˜ê³  ìˆê¸° ë•Œë¬¸ì— ìŠ¤ë ˆë“œê°„ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­í•  ë•ŒëŠ” ìŠ¤íƒ ì˜ì—­ì´ êµì²´ë©ë‹ˆë‹¤.
	- OSì— ì˜í•´ì„œ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ì´ ì¼ì–´ë‚©ë‹ˆë‹¤.
- ì½”ë£¨í‹´ì˜ ê²½ìš°
	- ì½”ë£¨í‹´ì´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë  ê²½ìš°, ìŠ¤íƒ ì˜ì—­ì´ êµì²´ë©ë‹ˆë‹¤.
	- ì½”ë£¨í‹´ì´ ê°™ì€ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë  ê²½ìš°, ë©”ëª¨ë¦¬ë¥¼ êµì²´í•  í•„ìš”ê°€ ì—†ìœ¼ë¯€ë¡œ ìŠ¤ë ˆë“œë³´ë‹¤ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ ë¹„ìš©ì´ ì ìŠµë‹ˆë‹¤.
	- ì½”ë“œë¥¼ í†µí•´ ê°œë°œìê°€ ì½”ë£¨í‹´ì´ ë‹¤ë¥¸ ì½”ë£¨í‹´ì—ê²Œ ì‹¤í–‰ì„ ì–‘ë³´í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (`yield()` í•¨ìˆ˜ ë“± subroutine ê°„ì˜ ìƒí˜¸ì‘ìš©)

## ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì„ ë” ì‰½ê³ , ë” ê°€ë³ê²Œ
ìš°ë¦¬ëŠ” íš¨ìœ¨ì ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ì„±ëŠ¥ì„ ìœ„í•´ ìŠ¤ë ˆë“œê°„ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ì„ ì´ìš©í•˜ì—¬ ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°ì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ìì¹« ë¬´ë¶„ë³„í•œ ìŠ¤ë ˆë“œ ìƒì„±ê³¼ ì»¨í…ìŠ¤íŠ¸ ìŠ¤ìœ„ì¹­ìœ¼ë¡œ ë§ì€ ë¦¬ì†ŒìŠ¤ë¥¼ ì†Œë¹„í•˜ê²Œ ë  ìˆ˜ ìˆë‹¤ëŠ” ì . ê·¸ë¦¬ê³  ì½”ë“œê°€ ë³µì¡í•´ì§„ë‹¤ëŠ” ë‹¨ì ì´ ìˆìŠµë‹ˆë‹¤.

ì½œë°± ì§€ì˜¥ì€ ë¶ˆì‹œì— ì°¾ì•„ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ‘€

![](https://miro.medium.com/v2/resize:fit:792/format:webp/0*MDSFS8Zy2WRlSlJ2.gif)
(ì´ë¯¸ì§€ ì¶œì²˜ : https://medium.com/nerd-for-tech/a-journey-from-callback-hell-to-kotlin-coroutines-episode-1-98b52821b323)

ì•„ë˜ëŠ” GPTì™€ í•¨ê»˜ ì§œë³¸ ìŠ¤ë ˆë“œ ì¹´í˜ ì˜ˆì‹œì…ë‹ˆë‹¤. `Callback`, `Future` ë“± ì£¼ë¬¸ì„ ê¸°ë‹¤ë¦¬ê±°ë‚˜ ì»¤í”¼ ë§Œë“œëŠ” ê²ƒì„ ê¸°ë‹¤ë¦¬ëŠ” ê°„ë‹¨í•œ ë¹„ë™ê¸° í•¨ìˆ˜ì¸ë° ì½”ë“œì˜ ë³µì¡ë„ê°€ ì‰½ê²Œ ì˜¬ë¼ê°‘ë‹ˆë‹¤.

```java
class Cafe {
    fun takeOrder(order: Order) {
        synchronized(orderQueue) {
            orderQueue.add(order)
        }
    }

    fun makeCoffeeAsync(): CompletableFuture<Order> {
        return CompletableFuture.supplyAsync {
            var order: Order? = null
            synchronized(orderQueue) {
                if (orderQueue.isNotEmpty()) {
                    order = orderQueue.removeAt(0)
                }
            }
            if (order != null) {
                Thread.sleep(2000L) // ì»¤í”¼ ë§Œë“œëŠ” ì‹œê°„
                order
            } else {
                null
            }
        }
    }

    fun serveCoffeeAsync(order: Order) {
        CompletableFuture.runAsync {
            Thread.sleep(500L) // ì»¤í”¼ ì„œë¹™ ì‹œê°„
            synchronized(completedOrders) {
                completedOrders.add(order)
            }
        }
    }
}

fun main() {
    val cafe = Cafe()
    val executor = Executors.newFixedThreadPool(3)

    val orderTask = CompletableFuture.runAsync {
        cafe.takeOrder(Order("Alice", "Latte"))
        Thread.sleep(1000L)
        cafe.takeOrder(Order("Bob", "Espresso"))
        Thread.sleep(1000L)
        cafe.takeOrder(Order("Charlie", "Cappuccino"))
    }

    val coffeeMakerTask = CompletableFuture.supplyAsync {
        while (true) {
            cafe.makeCoffeeAsync().thenAcceptAsync { order ->
                if (order != null) {
                    cafe.serveCoffeeAsync(order)
                }
            }.join()
        }
    }

    orderTask.thenRunAsync(coffeeMakerTask, executor)

    try {
        Thread.sleep(10000L)
    } catch (e: InterruptedException) {
        e.printStackTrace()
    }
    
    executor.shutdown()
}

```

ì´ëŸ° ì ì„ í•´ê²°í•˜ê¸° ìœ„í•´ì„œ ê° ì–¸ì–´ë§ˆë‹¤ ê³ ì•ˆí•œ ë°©ë²•ë“¤ì´ ë“±ì¥í•˜ì˜€ëŠ”ë°ìš”. Kotlin ì—ì„œëŠ” Coroutine ì´ í•´ê²°ì±…ìœ¼ë¡œ ë“±ì¥í•œ ê²ƒì…ë‹ˆë‹¤.

ì½”ë£¨í‹´ì€ Callbackì´ë‚˜ ë¸”ë¡ì—ì„œì˜ ì˜ˆì™¸ì²˜ë¦¬ ë“±ì„ ì½”ë“œ ë³µì¡ë„ë¥¼ ëœ ë†’ì´ë©´ì„œ í•  ìˆ˜ ìˆë„ë¡ ë•ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  OSì—ê²Œ ì‘ì—… ìŠ¤ì¼€ì¤„ë§ì„ ë„˜ê¸°ì§€ ì•Šê³ , ì½”ë“œë¥¼ í†µí•´ ê°œë°œìê°€ ì§ì ‘ ì‘ì—…ì„ ìŠ¤ì¼€ì¤„ë§í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

---
# Refs.
- https://tech.wonderwall.kr/articles/coroutinedeepdive/
- https://seunghyun.in/android/7/
- ì¸í”„ëŸ° ê°•ì˜ : 2ì‹œê°„ìœ¼ë¡œ ëë‚´ëŠ” ì½”ë£¨í‹´
- https://kotlinlang.org/docs/coroutines-guide.html
