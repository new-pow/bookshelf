# 퍼시스턴트 볼륨PV과 퍼시스턴트 볼륨 클레임 PVC
- 상태가 있는 애플리케이션의 경우 파드의 데이터를 영속적으로 저장하기 위한 방법이 필요합니다.
- 호스트에 위치한 디렉터리를 각 파드와 공유함으로써 데이터를 보존하는 것이 가능하지만, 여러 개의 서버로 구성된 쿠버네티스와 같은 클러스터 환경에서는 이 방법이 적합하지 않을 수 있습니다.
	- 다른 노드로 파드가 옮겨가면 데이터를 더이상 하용할 수 없어서 특정 노드에서만 파드를 실행하게 될 수도 있습니다.
- 그래서 어느 노드에서도 접근해 사용할 수 있는 퍼시스턴트 볼륨을 사용합니다.
- 퍼시스턴트 볼륨이란
	- 워커 노드들이 네트워크 상에서 스토리지를 마운트해 영속적으로 데이터를 저장할 수 있는 볼륨
	- 대표적인 예시로 NFS, AWS 의 EBS, Ceph, GlusterFS 등이 있습니다.

## 로컬 볼륨
### hostPath
- 호스트와 볼륨을 공유하기 위해서 사용
- CAdvisor와 같은 모니터링 툴을 쿠버네티스의 모든 워커 노드에 배포해야 한다면 사용하기 적합합니다. 하지만 이런 특수한 경우 외에는 보안/활용성 측면에서 그다지 바람직하지 않습니다.
- CAdvisor
	- cAdvisor는 컨테이너에 대한 정보를 수집, 처리 및 내보내는 데몬입니다.
	- cAdvisor는 컨테이너 기간별 리소스 사용량, 현재 또는 과거 리소스 사용량, 전체 리소스 사용량 히스토그램 및 네트워크 통계 등에 대한 정보를 유지합니다.
	- cAdvisor는 Kubelet 바이너리의 일부이므로 Kubelet과 긴밀하게 결합됩니다. Kubelet은 노드에서 컨테이너를 실행하고 관리하는 기본 노드 에이전트 입니다.
	- Kubernetes는 이러한 **메트릭(cpu,memory,network) 을 제공하는 모니터링 솔루션인** **cAdvisor**를 기본으로 제공합니다. -> 그러므로 별도 구축할 필요가 없습니다.
### emptyDir
- 파드의 컨테이너 간에 볼륨을 공유하기 위해 사용
- 파드가 실행되는 도중에만 필요한 휘발성 데이터를 각 컨테이너가 함께 사용할 수 있도록 임시 저장 공간을 생성합니다.
- 한 컨테이너가 파일을 관리하고 한 컨테이너가 그 파일을 사용하는 경우에 유용하게 사용할 수 있습니다.

## 네트워크 볼륨
- 네트워크로 접근할 수만 있으면 쿠버네티스 클러스터 내부, 외부 어느 곳에 존재해도 크게 상관 없습니다.
- 다만 AWS EBS와 같은 클라우드에 종속적인 볼륨을 사용하려면 AWS에서 쿠버네티스 클러스터를 생성할 때 특정 클라우드를 위한 옵션을 설정해야합니다.
- 예시
	- NFS, iSCSI, GlusterFS, Ceph 등...

### NFS
- Network File System
- 대부분의 운영 체제에서 사용할 수 있는 네트워크 스토리지
- 여러 개의 클라이언트가 동시에 마운트해 사용할 수 있다.
- NFS는 여러 개의 스토리지를 클러스터링하는 다른 솔루션에 비해 안정성이 떨어질 수 있습니다만 하나의 서버만으로 간편하게 사용할 수 있으며 NFS를 로컬 스토리지처럼 사용할 수 있습니다.
- https://www.ibm.com/docs/ko/aix/7.2?topic=management-network-file-system
- 주의
	- 실제 운영환경에서는 NFS 서버를 도입하려면 백업 스토리지를 별도로 구축해 데이터 손실에 대비하거나 NFS 서버의 설정 튜닝 및 NFS 서버에 접근하기 위한 DNS 이름을 준비해야 할 수도 있습니다.

## PV, PVC를 이용한 볼륨 관리
https://kubernetes.io/ko/docs/concepts/storage/persistent-volumes/
- 왜 PV, PVC를 사용하는가?
	- 이전의 방식을 사용하면 볼륨과 애플리케이션 정의가 서로 밀접하게 연관되어 있어 서로 분리할 수 없는 상황이 되어버립니다.
- 쿠버네티스에서는 퍼시스턴트 볼륨과 퍼시스턴트 볼륨 클레임이라는 오브젝트를 제공합니다.
	- 이 두 오브젝트는 파드가 볼륨의 세부적인 사항을 몰라도 볼륨을 사용할 수 있도록 추상화해주는 역할을 담당합니다.
- 퍼시스턴트 볼륨과 퍼시스턴트 볼륨 클레임의 accessMode 및 볼륨 크기 속성이 부합해야만 쿠버네티스는 두 리소스를 매칭해 바인드합니다.
	- AWS의 경우, 1:1 마운트 + NGi의 볼륨이 필요하다고 명시하면 해당 조건을 만족하는 AWS EBS 볼륨과 마운트됩니다.
- accessMode 종류
	- ReadWriteOnce
	- ReadOnlyMany
	- ReadWrtieMany
- 혹은 볼륨을 연결할 때 라벨 셀렉터를 사용할 수 있습니다.
	- 이전에 서비스와 디플로이먼트를 서로 연결할 때 라벨 셀렉터를 사용했던 것처럼 퍼시스턴트 볼륨 클레임에 라벨 셀렉터인 matchLabels 항목을 정의함으로써 특정 퍼시스턴트 볼륨과 바인드하는 것도 가능합니다.
- PV란?
	- _퍼시스턴트볼륨_ (PV)은 관리자가 프로비저닝하거나 [스토리지 클래스](https://kubernetes.io/ko/docs/concepts/storage/storage-classes/)를 사용하여 동적으로 프로비저닝한 클러스터의 스토리지이다. 노드가 클러스터 리소스인 것처럼 PV는 클러스터 리소스이다. PV는 Volumes와 같은 볼륨 플러그인이지만, PV를 사용하는 개별 파드와는 별개의 라이프사이클을 가진다. 이 API 오브젝트는 NFS, iSCSI 또는 클라우드 공급자별 스토리지 시스템 등 스토리지 구현에 대한 세부 정보를 담아낸다.
- PVC란?
	- _퍼시스턴트볼륨클레임_ (PVC)은 사용자의 스토리지에 대한 요청이다. 파드와 비슷하다. 파드는 노드 리소스를 사용하고 PVC는 PV 리소스를 사용한다. 파드는 특정 수준의 리소스(CPU 및 메모리)를 요청할 수 있다. 클레임은 특정 크기 및 접근 모드를 요청할 수 있다.

## StorageClass와 Dynamic Provisioning
- 다이나믹 프로비저닝
	- 퍼시스턴트 볼륨 클레임이 요구하는 조건과 일치하는 퍼시스턴트 볼륨이 존재하지 않는다면 자동으로 퍼시스턴트 볼륨과 외부 스토리지를 함께 프로비저닝하는 기능
- 

# 자주 쓸만한 명령어
- 클러스터 내의 특정 파드에 있는 컨테이너에서 명령어를 실행하는 데 사용
```
kubectl exec -it iirin-emptydir-pod -c content-creator -- /bin/sh
```
